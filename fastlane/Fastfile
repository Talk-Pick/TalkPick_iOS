# Fastfile - Fastlane 설정
# https://docs.fastlane.tools/

# 기본 설정
default_platform(:ios)

platform :ios do
  # 빌드 전에 프로젝트를 생성하는 lane
  # Tuist 프로젝트의 경우 먼저 tuist generate를 실행해야 합니다
  lane :generate_project do
    sh("tuist generate")
  end

  # 테스트 실행
  desc "Run tests"
  lane :test do
    generate_project
    run_tests(
      workspace: "TalkPick.xcworkspace",
      scheme: "TalkPick",
      device: "iPhone 16 Pro"
    )
  end

  # 빌드 (Development)
  desc "Build the app for development"
  lane :build do
    generate_project
    build_app(
      workspace: "TalkPick.xcworkspace",
      scheme: "TalkPick",
      configuration: "Debug"
    )
  end

  # 인증서 및 프로비저닝 프로파일 설정
  desc "Setup certificates and provisioning profiles"
  lane :certificates do
    match(
      type: "development",
      readonly: true
    )
  end

  # 빌드 및 아카이브 (App Store용)
  desc "Build and archive the app for App Store"
  lane :beta do
    generate_project
    # 인증서 및 프로비저닝 프로파일 자동 관리
    # match를 사용하는 경우 아래 주석을 해제하세요
    # match(type: "appstore", readonly: true)
    
    # 빌드 및 아카이브
    # Xcode의 자동 서명을 사용하는 경우 별도 설정 불필요
    build_app(
      workspace: "TalkPick.xcworkspace",
      scheme: "TalkPick",
      configuration: "Release",
      export_method: "app-store"
    )
  end

  # TestFlight에 업로드
  desc "Upload to TestFlight"
  lane :beta_upload do
    increment_build_number(
      xcodeproj: "TalkPick.xcodeproj"
    )
    beta
    upload_to_testflight(
      skip_waiting_for_build_processing: true
      # App Store Connect API Key를 사용하는 경우 아래 옵션을 사용하세요
      # api_key_path: "fastlane/AuthKey_XXXXXXXX.p8",
      # api_key: app_store_connect_api_key(
      #   key_id: "YOUR_KEY_ID",
      #   issuer_id: "YOUR_ISSUER_ID",
      #   key_filepath: "fastlane/AuthKey_XXXXXXXX.p8"
      # )
    )
  end

  # App Store에 배포
  desc "Deploy to App Store"
  lane :release do
    beta
    upload_to_app_store(
      force: true,
      submit_for_review: false,
      automatic_release: false,
      skip_metadata: true,
      skip_screenshots: true
    )
  end

  # 버전 번호 증가
  desc "Increment build number"
  lane :increment_build do
    increment_build_number(
      xcodeproj: "TalkPick.xcodeproj"
    )
  end

  # 버전 번호 증가 및 빌드
  desc "Increment version and build"
  lane :increment_version do
    increment_version_number(
      xcodeproj: "TalkPick.xcodeproj"
    )
    increment_build_number(
      xcodeproj: "TalkPick.xcodeproj"
    )
  end
end